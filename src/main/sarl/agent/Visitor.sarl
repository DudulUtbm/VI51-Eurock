package ^agent

import Behaviour.KinematicSeekBehaviour
import Behaviour.KinematicWanderBehaviour
import Behaviour.SeekBehaviour
import Behaviour.WanderBehaviour
import io.sarl.core.Initialize
import io.sarl.core.Lifecycle
import org.arakhne.afc.math.continous.object2d.Point2f
import vi51.util.ConstantContainer
import org.arakhne.afc.math.continous.object2d.Circle2f
import java.util.ArrayList
import vi51.environment.Perceivable
import org.arakhne.afc.math.continous.object2d.Vector2f
import vi51.util.Semantic

/**
 * @author Dudul
 *
 */
agent Visitor extends AbstractAnimat {

	uses  Lifecycle
	
	var seekBehaviour : SeekBehaviour
	var wanderBehaviour : WanderBehaviour
	var recommandation : String
	
	var listenMusic = ConstantContainer.BASIC_MUSIC_DESIRE
	var drink = ConstantContainer.BASIC_THIRSTY
	var hungry = ConstantContainer.BASIC_HUNGRY
	  
	on Initialize{
		super._handle_Initialize_0(occurrence) 
	}
	
	/**
	 * return a new vector that should be the next velocity to respect private zone
	 */
	def PrivateZone(position : Point2f, liste : ArrayList<Perceivable>,velocity : Vector2f, targetType : Semantic) : Vector2f{
		// Si target Buvette ou toilette s'arrÃªter pour faire la queue, sinon contourner
		var returnVector = velocity
		var radius = new Circle2f(position,ConstantContainer.PRIVATE_RADIUS)
			for(object : liste){
				if(radius.intersects(object.getBox)){
					if(!targetType.equals("DrinkStand")&&!targetType.equals("EatStand")&&!targetType.equals("Toilet"))
					{
						var angle = velocity.signedAngle(object.getCurrentLinearMotion())
						if(angle<90)
						returnVector.turnVector(angle)
					}
					else
					{
						returnVector = new Vector2f(0,0)
					}
				}
			}
			
			return returnVector
	}	
	
	
	on Perception{
		var body = occurrence.body
		var target : Point2f = null
		var targetType : String = null
		if(occurrence.objects.size()>0){
			for (object : occurrence.objects){
				if (object.getType.equals("Scene")){
					target = object.getPosition()
					targetType = "Scene"
				}
				else if (object.getType.equals("Toilet")){
					target = object.getPosition()
					targetType="Toilet"
				}
				else if (object.getType.equals("DrinkStand")){
					target = object.getPosition()
					targetType="DrinkStand"
				}
				else if (object.getType.equals("EatStand")){
					target = object.getPosition()
					targetType="EatStand"
				}
				else if (object.getType.equals("Gate")){
					target = object.getPosition()
					targetType="Gate"
				}
				// Groupe favori
				else if (object.getName.equals(this.recommandation)){
					target = object.getPosition()
				}
			}
			if(target!=null){
				this.seekBehaviour = new KinematicSeekBehaviour
				var o = this.seekBehaviour.runSeek(
					body.position,
					body.currentLinearMotion.length,
					body.maxLinearSpeed,
					target
				)
				o.emitInfluence(occurrence.time)
			}else{
				this.wanderBehaviour = new KinematicWanderBehaviour
				//position : Point2f, orientation : Vector2f, linearSpeed : float, maxLinear : float, angularSpeed : float, maxAngular : float
				var o = this.wanderBehaviour.runWander(
				body.position,
				body.currentLinearMotion,
				body.currentLinearMotion.length,
				body.maxLinearSpeed,
				body.currentAngularSpeed,
				body.maxAngularSpeed
				)
				o.emitInfluence(occurrence.time)
			}
		}else{
			this.wanderBehaviour = new KinematicWanderBehaviour
			//position : Point2f, orientation : Vector2f, linearSpeed : float, maxLinear : float, angularSpeed : float, maxAngular : float
			var o = this.wanderBehaviour.runWander(
			body.position,
			body.currentLinearMotion,
			body.currentLinearMotion.length,
			body.maxLinearSpeed,
			body.currentAngularSpeed,
			body.maxAngularSpeed
			)
			o.emitInfluence(occurrence.time)
		}
		
		
	}
}